<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8" />

    <title>Scrolling - List</title>
    <link rel="stylesheet" type="text/css" href="x-tag-components.css" />
    
    <script type="text/javascript" src="x-tag-components.js"></script>
    
    <style>
      #list{
        height: 600px;
      }
      #buttons {
        float: right;
      }
    </style>
  </head>
  
<body>
  <h2>X-Tag Scrolling List</h2>
  <div id="buttons">
    <button data-items="100">Load 100 Items</button>

    <button data-items="1000">Load 1000 Items</button>

    <button data-items="10000">Load 10000 Items</button>

    <button data-items="50000">Load 50000 Items</button>

    <a href="base.html">HTML Version</a>

  </div>

  <x-scrolling-list id="list">

  </x-scrolling-list>

 

</body>

<script type="text/javascript">
  document.addEventListener('DOMContentLoaded', function(){

    if (navigator.mozApps){
      var installed = navigator.mozApps.getSelf();
      installed.onsuccess = function(){
        if (installed.result){
          // already installed
        } else {
          var install = navigator.mozApps.install('http://x-tag.github.com/scroll-list/manifest.webapp');
          install.onsuccess = function(){
            console.log('Installed');
          }
          install.onerror = function(){
            console.log('install failed', this.error);
          }
        }
      }
    }

    var list = document.getElementById('list');
    list.render = function(elem, data, idx){
      
      if(!elem.firstChild){
        elem.innerHTML = '<div></div><p class="text_caption"></p><div></div>';
      }

      elem.dataset.id = idx;
      elem.children[0].innerHTML = "From: " + data.sender;
      elem.children[1].innerHTML = data.body;      
    }

    if(navigator.mozSms){
      getSmsMessages(function(messages){
        list.items = messages;
      });
    }
    else {
      list.items = generateList();  
    }
    

  });

  xtag.addEvent(document.body,'click:delegate(button)', function(e){
    var items = [], iter = e.target.dataset.items;
    while(iter--){
      items.splice(0,0, createMockSms(iter));
    }
    document.getElementById('list').items = items;
  });

  function generateList(){
    var items = [], iter = 50;
    while(iter--){
      items.splice(0,0, createMockSms(iter));
    }
    return items;
  }

  function getSmsMessages(callback){
    var smsRequest = navigator.mozSms.getMessages(new SmsFilter(), false);
    smsRequest.onsuccess = function(){
      console.log(smsRequest.result);
      callback(smsRequest.result);
    }
    smsRequest.onerror = function(){
      console.log("error");
      callback([]);
    }
  }

  function createMockSms(iter){
    return { 
        sender: 'user_ '+ iter, 
        body: 'message ' + iter, 
        timestamp: new Date(iter * 1000), 
        receiver: 'Me',
        delivery: iter % 1 == 0 ? 'received' : 'sent'
      };
  }

</script>

</html>
